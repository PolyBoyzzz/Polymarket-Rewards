# Polymarket 自动做市机器人文档
## 需要完整代码请联系TG：[@polyboy123](https://t.me/polyboy123)

## 一、系统概述

### 1.1 核心功能

本系统是一个基于流动性奖励的自动化做市策略程序，通过智能挂单获取 Polymarket 平台的流动性奖励。系统能够：

- 自动扫描和筛选有流动性奖励的市场
- 在奖励区间边界智能挂单
- 自动管理订单（补单、价格调整、对冲卖出）
- 实时风险控制和敞口管理
- 使用 Redis 缓存优化数据获取性能

### 1.2 技术架构

- **语言**: Python 3.12
- **主要依赖**: py-clob-client（Polymarket 官方 SDK）、Redis、requests
- **数据存储**: Redis（订单簿缓存、市场数据缓存）
- **API 通信**: HTTP REST API（Polymarket API、订单簿服务）

---

## 二、核心模块说明

### 2.1 主程序模块（main.py）

**职责**: 程序入口，协调所有模块，实现主循环逻辑

**主要流程**:

1. **初始化阶段**:
   - 初始化所有组件（API客户端、市场管理器、订单管理器、风险管理器、做市策略）
   - 取消所有现有的购买挂单（确保干净启动）
   - 检查订单簿数据服务状态

2. **初始市场扫描和筛选**:
   - 扫描所有有流动性奖励的市场
   - 使用多维度筛选（价差、交易量、奖励份额、时间限制、黑名单等）
   - 计算收益比值并排序
   - 为选中的市场挂单

3. **主循环**（三个并行任务）:
   - **订单状态检查**（每 0.5 秒）:
     - 实时交易检测（`check_trades_and_hedge`）：通过 `get_trades()` 实时检测买单成交并立即对冲卖出
     - 持仓检查（`check_positions_and_hedge`）：确保所有持仓都有对冲卖单
     - 订单检查（`check_orders`）：检测订单成交状态，处理补单逻辑

   - **价格调整**（每 0.5 秒）:
     - 获取实时订单簿数据
     - 计算新的奖励区间边界价格
     - 如果价格偏离超过阈值，取消旧订单并重新挂单

   - **市场重新扫描**（每 1200 秒，20分钟）:
     - 取消所有当前活跃市场的未成交挂单
     - 重新扫描和筛选市场
     - 为新机会市场挂单

4. **优雅关闭**:
   - 取消所有购买挂单
   - 显示最终统计信息

---

### 2.2 市场管理器（market_manager.py）

**职责**: 市场数据管理、市场筛选、收益比值计算

**核心功能**:

1. **市场扫描** (`scan_rewards_markets`):
   - 从 Redis 缓存或 API 获取所有有流动性奖励的市场
   - 支持分页自动获取

2. **市场筛选** (`filter_markets`):
   - **多维度过滤**:
     - 价差范围过滤（实时计算）
     - 24小时交易量过滤
     - 最小奖励份额过滤
     - 每日奖励率过滤
     - 市场结束时间过滤（避免临近结束的高波动市场）
     - 问题黑名单过滤（关键词匹配）

   - **收益比值计算** (`calculate_reward_ratio`):
     - 公式：`收益比 = (我们的订单份额 × 2) / (竞争者总份额) × 每天奖励额`
     - 我们的订单份额 = `rewards_min_size × order_size_multiplier × 2`（双边挂单）
     - 竞争者总份额 = 买一价+买二价+卖一价+卖二价的份额总和

   - **挂单安全检查** (`_check_market_can_place_orders`):
     - 判断是否需要双边挂单（任何 token 的中间价 ≤ 0.10）
     - 对每个 token 进行风险管理检查（价格断层、保护份额、波动率等）
     - 需要双边挂单的市场：所有 token 都必须通过检查
     - 正常市场：至少有一个 token 通过检查即可

3. **市场数据缓存**:
   - 缓存市场数据，避免重复查询

---

### 2.3 订单管理器（order_manager.py）

**职责**: 订单生命周期管理、自动补单、对冲卖出、价格调整

**核心功能**:

1. **订单挂单** (`place_market_orders`):
   - 为市场的每个 token 挂买单和卖单
   - 在奖励区间边界挂单（买二价或奖励下边界）
   - 风险管理检查（价格断层、保护份额、波动率）
   - 敞口限制检查

2. **订单检查** (`check_orders`):
   - **双重检测机制**:
     - **优先方法**：使用持仓信息检测（买单成交会增加持仓）
     - **补充方法**：使用交易历史查询

   - **部分成交跟踪**:
     - 跟踪部分成交订单的剩余部分
     - 对新成交部分立即挂出对冲卖单

   - **处理逻辑**:
     - 完全成交：从活跃订单中移除，触发补单和对冲卖出
     - 部分成交：添加到跟踪列表，对已成交部分立即对冲卖出

3. **实时交易检测** (`check_trades_and_hedge`):
   - **主要对冲机制**:
     - 调用 `get_trades(after=last_trade_check_time)` 获取新交易
     - 识别自己的买单成交（通过地址/API密钥匹配）
     - 处理分段买入（使用 `order_filled_tracking` 跟踪累计成交）
     - 对每次 trade 的成交份额立即调用 `place_hedge_sell()`
     - 如果对冲失败，加入异步重试队列

4. **持仓检查** (`check_positions_and_hedge`):
   - **兜底对冲机制**:
     - 查询所有持仓
     - 检查每个持仓是否已有对冲卖单
     - 如果持仓份额与已挂卖单份额不一致，重新挂出全仓卖出订单
     - 冷却期机制：对冲失败后30秒内不重试

5. **对冲卖出** (`place_hedge_sell`):
   - **价格计算策略**（按优先级）:
     1. **智能价格层选择**：从订单簿中选择能够覆盖全部卖出份额的最低价格层（在 `max_bid_gap` 阈值内）
     2. **回退到买一价**：如果买一价与买入价的价差 ≤ `max_bid_gap`
     3. **原价逻辑**：`max(买入价, 当前市场价) + 最小利润`

   - **持仓验证**:
     - 查询实际持仓
     - 计算可用持仓 = 实际持仓 - 已挂出卖单份额
     - 确保有足够持仓才挂出卖单

6. **价格调整** (`adjust_orders_to_reward_boundaries`):
   - 获取实时订单簿数据
   - 计算新的奖励区间边界价格
   - 如果价格偏离超过阈值（`price_deviation_threshold_bps`），取消旧订单并重新挂单

7. **异步重试机制**:
   - 对冲卖出失败的任务加入重试队列
   - 后台线程定期重试（固定延迟1秒）
   - 最大重试次数：10次

---

### 2.4 做市策略模块（market_making_strategy.py）

**职责**: 价格计算、风险管理检查、订单份额计算

**核心功能**:

1. **价格计算**:
   - **中间价计算** (`calculate_mid_price`): `(best_bid + best_ask) / 2`
   - **奖励区间计算** (`calculate_reward_range`):
     - 买单价格 = 中间价 - `(rewards_max_spread - 1) / 100`
     - 卖单价格 = 中间价 + `(rewards_max_spread - 1) / 100`
   - **价格规范化** (`normalize_price`):
     - 根据市场的最小价格步长（`orderPriceMinTickSize`）向下取整
     - 限制在有效范围内 [0.01, 1.0]

2. **实际挂单价格计算** (`calculate_actual_buy_price`):
   - 如果订单簿只有买一价，返回 None（跳过）
   - 如果买二价 ≥ 奖励下边界，返回买二价
   - 如果买二价 < 奖励下边界，返回奖励下边界

3. **风险管理检查** (`can_place_buy_order_safely`):
   - **波动率检查**:
     - 从 Redis 获取波动率数据
     - 如果波动率超过阈值，拒绝挂单

   - **位置检查**:
     - 如果使用奖励下边界挂单，检查挂单后是否成为买二价
     - 如果使用买二价挂单，跳过位置检查

   - **价格断层检查**:
     - 检查后1价、后2价是否存在
     - 检查价格差是否超过阈值（`price_cliff_threshold`）

   - **保护份额检查**:
     - 买一价和买二价的总份额 ≥ `订单份额 × min_protection_size_multiplier`

   - **对冲卖出份额检查**:
     - 买三价、买四价等（在 `max_bid_gap` 阈值内）的累计份额 ≥ `订单份额 × min_protection_size_multiplier_hedge`

4. **订单份额计算** (`calculate_order_size`):
   - 实际下单份额 = `rewards_min_size × order_size_multiplier`
   - 至少为市场最小份额

5. **对冲卖出价格计算** (`calculate_hedge_sell_price`):
   - 智能价格层选择（优先）
   - 回退到买一价
   - 原价逻辑（最后备选）

---

### 2.5 风险管理器（risk_manager.py）

**职责**: 敞口跟踪、最大敞口限制

**核心功能**:

1. **敞口计算** (`calculate_exposure`):
   - 买单敞口 = `订单价格 × 订单份额`
   - 卖单不计算敞口（卖出已持有的 token，不需要投入新资金）

2. **敞口限制检查** (`can_place_order`):
   - 卖单直接允许下单
   - 买单需要检查：`当前敞口 + 新订单敞口 ≤ max_exposure_per_market_usdc`

3. **敞口管理**:
   - **下单时** (`add_exposure`): 添加挂单敞口
   - **订单取消时** (`remove_exposure`): 移除挂单敞口
   - **订单成交时** (`add_filled_order_exposure`): 添加已成交订单敞口（占用资金）
   - **对冲卖出时** (`remove_filled_order_exposure`): 移除已成交订单敞口（卖单成交后释放资金）

---

### 2.6 API 客户端（api_client.py）

**职责**: 与 Polymarket API 通信

**核心功能**:

1. **市场数据获取**:
   - `get_rewards_markets()`: 获取有流动性奖励的市场（支持分页）
   - `get_all_rewards_markets()`: 自动处理分页，获取所有市场（优先从 Redis 缓存读取）

2. **订单簿数据获取**:
   - `get_orderbook(token_id)`: 获取单个 token 的订单簿
   - `get_markets_orderbooks(markets)`: 批量获取多个市场的订单簿（优先从 Redis 缓存读取）

3. **订单操作**（通过 py-clob-client）:
   - 下单、取消订单、查询订单、查询持仓、查询交易历史

---

### 2.7 订单簿数据服务（orderbook_data_service.py / redis_orderbook_client.py）

**职责**: 订单簿数据缓存、市场数据缓存、波动率计算

**核心功能**:

1. **数据缓存**:
   - 市场列表缓存（TTL: 5分钟）
   - 订单簿数据缓存（TTL: 300秒）
   - 完整市场详情缓存（TTL: 7天）

2. **波动率计算**:
   - 滑动窗口计算（窗口大小：30个数据点，约15分钟）
   - 使用变异系数（标准差/均值）作为波动率指标
   - 如果波动率超过阈值，标记为危险市场

3. **数据更新**:
   - 定期扫描市场列表（每5分钟）
   - 定期更新订单簿数据（每3秒）
   - 批量获取市场详情（每批次20个）

---

## 三、关键业务流程

### 3.1 市场筛选流程

```
1. 扫描所有有流动性奖励的市场
   ↓
2. 黑名单过滤（问题关键词）
   ↓
3. 交易量过滤（24小时交易量范围）
   ↓
4. 奖励份额过滤（rewards_min_size 范围）
   ↓
5. 批量获取订单簿数据（从 Redis 缓存）
   ↓
6. 实时价差过滤（从订单簿计算）
   ↓
7. 时间过滤（市场结束时间限制）
   ↓
8. 每日奖励率过滤
   ↓
9. 计算收益比值（考虑竞争情况）
   ↓
10. 挂单安全检查（价格断层、保护份额、波动率）
   ↓
11. 按收益比值降序排序
   ↓
12. 选择前 N 个市场
```

### 3.2 订单挂单流程

```
1. 获取市场数据（tokens、rewards_max_spread 等）
   ↓
2. 判断是否需要双边挂单（任何 token 中间价 ≤ 0.10）
   ↓
3. 对每个 token：
   a. 获取实时订单簿数据
   b. 计算中间价
   c. 计算奖励区间边界（buy_price, sell_price）
   d. 计算实际挂单价格（买二价或奖励下边界）
   e. 风险管理检查（价格断层、保护份额、波动率）
   f. 敞口限制检查
   g. 挂买单和卖单
```

### 3.3 订单检查和对冲流程

```
主循环中的订单检查（每 0.5 秒）：
   ↓
1. 实时交易检测（check_trades_and_hedge）
   - 获取新交易记录（get_trades）
   - 识别自己的买单成交
   - 立即对冲卖出（place_hedge_sell）
   ↓
2. 持仓检查（check_positions_and_hedge）
   - 查询所有持仓
   - 检查是否已有对冲卖单
   - 如果持仓与卖单不一致，重新挂出全仓卖出订单
   ↓
3. 订单检查（check_orders）
   - 检测订单成交状态（持仓信息 + 交易历史）
   - 处理完全成交：补单 + 对冲卖出
   - 处理部分成交：跟踪 + 对冲卖出
```

### 3.4 价格调整流程

```
1. 获取当前活跃市场列表
   ↓
2. 对每个市场：
   a. 获取实时订单簿数据
   b. 计算新的奖励区间边界价格
   c. 检查价格偏离是否超过阈值
   d. 如果超过阈值：
      - 取消旧订单
      - 重新挂单（使用新价格）
```

### 3.5 市场重新扫描流程

```
1. 取消所有当前活跃市场的未成交挂单
   ↓
2. 重新检查持仓并重挂卖单（使用新的 TP/SL 策略）
   ↓
3. 重新扫描所有有流动性奖励的市场
   ↓
4. 重新筛选市场（使用最新数据）
   ↓
5. 只为新市场挂单（排除仍在活跃列表中的市场）
```

---

## 四、关键配置参数

### 4.1 做市策略配置

| 参数                           | 说明                     | 默认值 |
| ------------------------------ | ------------------------ | ------ |
| `order_size_multiplier`        | 订单份额倍数             | 1.0    |
| `max_exposure_per_market_usdc` | 每市场最大敞口（USDC）   | 25     |
| `max_markets`                  | 最大选择市场数量         | 10     |
| `min_reward_ratio`             | 最小奖励比值阈值         | 0      |
| `min_profit_margin_bps`        | 对冲卖出最小利润（基点） | 5      |

### 4.2 风险管理配置

| 参数                                   | 说明                     | 默认值 |
| -------------------------------------- | ------------------------ | ------ |
| `price_cliff_threshold`                | 价格断层阈值（绝对差值） | 0.05   |
| `min_protection_size_multiplier`       | 最小保护份额倍数         | 1.0    |
| `min_protection_size_multiplier_hedge` | 对冲保护份额倍数         | 5.0    |

### 4.3 对冲卖出配置

| 参数                                | 说明             | 默认值 |
| ----------------------------------- | ---------------- | ------ |
| `hedge_sell.max_bid_gap`            | 最大买价差值阈值 | 0.05   |
| `hedge_sell.stop_loss_pct`          | 止损百分比       | 0.10   |
| `hedge_sell.take_profit_pct`        | 止盈百分比       | 0.10   |
| `hedge_sell.dynamic_follow_enabled` | 是否启用动态跟随 | true   |

### 4.4 市场筛选配置

| 参数                     | 说明                     | 默认值                   |
| ------------------------ | ------------------------ | ------------------------ |
| `spread_range`           | 价差过滤范围             | `{min: null, max: 0.05}` |
| `volume_24hr_range`      | 24小时交易量过滤范围     | `{min: null, max: null}` |
| `rewards_min_size_range` | 最小奖励份额过滤范围     | `{min: null, max: 20}`   |
| `rate_per_day_range`     | 每日奖励率过滤范围       | `{min: 5, max: null}`    |
| `min_days_until_end`     | 最小剩余天数             | 7                        |
| `question_blacklist`     | 问题黑名单（关键词列表） | `["Trump"]`              |

### 4.5 主循环配置

| 参数                                | 说明                     | 默认值 |
| ----------------------------------- | ------------------------ | ------ |
| `update_interval_seconds`           | 市场扫描更新间隔（秒）   | 1200   |
| `order_check_interval_seconds`      | 订单状态检查间隔（秒）   | 0.5    |
| `orderbook_update_interval_seconds` | 订单簿监控更新间隔（秒） | 0.5    |
| `price_deviation_threshold_bps`     | 价格偏离阈值（基点）     | 0.0001 |

### 4.6 订单簿数据服务配置

| 参数                                                      | 说明                   | 默认值    |
| --------------------------------------------------------- | ---------------------- | --------- |
| `orderbook_service.enabled`                               | 是否启用订单簿数据服务 | true      |
| `orderbook_service.market_scan_interval`                  | 市场扫描间隔（秒）     | 300       |
| `orderbook_service.orderbook_update_interval`             | 订单簿更新间隔（秒）   | 3         |
| `orderbook_service.redis.host`                            | Redis 主机             | localhost |
| `orderbook_service.redis.port`                            | Redis 端口             | 6379      |
| `orderbook_service.volatility_check.enabled`              | 是否启用波动率检查     | true      |
| `orderbook_service.volatility_check.volatility_threshold` | 波动率阈值             | 0.03      |

---

## 五、数据结构

### 5.1 市场数据结构

```python
{
    "market_id": "570361",
    "condition_id": "0xcb11...",
    "question": "市场问题",
    "tokens": [
        {
            "token_id": "0x...",
            "outcome": "Yes"
        }
    ],
    "rewards_config": [
        {
            "rate_per_day": 10.5  # 每天奖励额（USDC）
        }
    ],
    "rewards_max_spread": 3.5,  # 奖励最大价差（美分）
    "rewards_min_size": 200,  # 最小奖励份额
    "volume_24hr": 5000.0,  # 24小时交易量（USDC）
    "spread": 0.03,  # 价差
    "reward_ratio": 0.001234  # 收益比值（计算得出）
}
```

### 5.2 订单数据结构

```python
{
    "order_id": "0x...",
    "token_id": "0x...",
    "market_id": "570361",
    "side": "BUY",  # 或 "SELL"
    "price": 0.65,
    "size": 200,
    "status": "OPEN",  # 或 "FILLED", "CANCELLED"
    "filled_size": 100,  # 已成交份额
    "created_at": "2025-01-01T00:00:00Z"
}
```

### 5.3 活跃订单跟踪结构

```python
active_orders = {
    "market_id": {
        "token_id": {
            "BUY": {
                "order_id": "0x...",
                "price": 0.65,
                "size": 200,
                ...
            },
            "SELL": {
                "order_id": "0x...",
                "price": 0.70,
                "size": 200,
                ...
            }
        }
    }
}
```

---

## 六、风险控制机制

### 6.1 敞口限制

- 每市场最大敞口限制（`max_exposure_per_market_usdc`）
- 买单计算敞口，卖单不计算敞口
- 已成交订单占用敞口，直到对冲卖出成交

### 6.2 价格断层检查

- 检查后1价、后2价是否存在
- 检查价格差是否超过阈值（`price_cliff_threshold`）
- 如果存在价格断层，拒绝挂单

### 6.3 保护份额检查

- 买一价和买二价的总份额必须 ≥ `订单份额 × min_protection_size_multiplier`
- 确保有足够的保护，不容易被吃掉

### 6.4 对冲卖出份额检查

- 买三价、买四价等（在 `max_bid_gap` 阈值内）的累计份额必须 ≥ `订单份额 × min_protection_size_multiplier_hedge`
- 确保有足够的流动性用于对冲卖出

### 6.5 波动率检查

- 使用滑动窗口计算价格波动率（变异系数）
- 如果波动率超过阈值，拒绝挂单
- 避免高波动市场的风险

### 6.6 市场筛选过滤

- 价差范围过滤
- 交易量过滤
- 奖励份额过滤
- 时间过滤（避免临近结束的高波动市场）
- 黑名单过滤（避免特定主题的市场）

---

## 七、性能优化

### 7.1 Redis 缓存

- 市场列表缓存（减少 API 调用）
- 订单簿数据缓存（提高数据获取速度）
- 完整市场详情缓存（减少重复查询）

### 7.2 批量操作

- 批量获取订单簿数据
- 批量获取市场详情
- 批量取消订单

### 7.3 异步处理

- 对冲卖出失败的任务加入异步重试队列
- 后台线程定期重试，不阻塞主循环

### 7.4 增量检查

- 只检查上次检查后的新交易（`get_trades(after=last_trade_check_time)`）
- 避免重复处理已处理的交易

### 7.5 锁优化

- 在锁外复制数据结构，避免长时间持有锁
- 使用细粒度锁，减少锁竞争

---

## 八、错误处理和重试机制

### 8.1 API 请求重试

- 指数退避重试（最多3次）
- 超时设置（30秒）

### 8.2 订单操作重试

- 订单重试次数：3次
- 订单重试延迟：1.0秒

### 8.3 对冲卖出重试

- 异步重试队列
- 最大重试次数：10次
- 固定重试延迟：1.0秒
- 冷却期机制：失败后30秒内不重试

### 8.4 异常处理

- 所有关键操作都有异常处理
- 异常不会中断主循环
- 详细的错误日志记录

---

## 九、日志系统

### 9.1 日志级别

- **控制台日志级别**: INFO（默认）
- **文件日志级别**: WARNING（默认）

### 9.2 日志文件

- 按日期和模块分类：
  - `logs/YYYY-MM-DD/main.log` - 主程序日志
  - `logs/YYYY-MM-DD/order_manager.log` - 订单管理器日志
  - `logs/YYYY-MM-DD/market_manager.log` - 市场管理器日志
  - `logs/YYYY-MM-DD/api_client.log` - API 客户端日志
  - `logs/YYYY-MM-DD/risk_manager.log` - 风险管理器日志
  - `logs/YYYY-MM-DD/market_making_strategy.log` - 做市策略日志

### 9.3 性能日志

- 记录关键操作的耗时
- 例如：`[性能] check_trades_and_hedge() 耗时: 0.123秒`

---

## 十、部署和运行

### 10.1 环境要求

- Python 3.12+
- Redis 服务器（用于数据缓存）
- 网络连接（访问 Polymarket API）

### 10.2 环境变量

```bash
POLYMARKET_PRIVATE_KEY=your_private_key_here
POLYMARKET_FUNDER=your_funder_address_here
POLYMARKET_API_KEY=your_api_key_here  # 可选，用于订单匹配
```

### 10.3 配置文件

- `config.yaml`: 主配置文件
- 包含所有可配置参数

### 10.4 运行方式

```bash
# 启动订单簿数据服务（用于数据缓存和波动率计算）
python start_orderbook_service.py
```


```bash
# 前台运行
python main.py

# 后台运行（守护进程模式，仅 Linux/Mac）
python main.py --daemon

# 停止模式（取消所有买单后退出）
python main.py --stop
```

---

## 十一、关键特性总结

### 11.1 智能市场筛选

- 多维度过滤（价差、交易量、奖励份额、时间、黑名单）
- 收益比值计算（考虑竞争情况）
- 挂单安全检查（价格断层、保护份额、波动率）

### 11.2 智能挂单策略

- 在奖励区间边界挂单（最大化奖励获取概率）
- 买二价或奖励下边界（确保成为买二价）
- 风险管理检查（确保安全）

### 11.3 自动订单管理

- 订单成交后自动补单
- 买单成交后立即对冲卖出（双重机制：实时交易检测 + 持仓检查）
- 实时调整订单价格（保持在奖励区间边界）

### 11.4 风险控制

- 每市场最大敞口限制
- 价格断层检查
- 保护份额检查
- 波动率检查
- 市场筛选过滤

### 11.5 性能优化

- Redis 缓存（减少 API 调用）
- 批量操作（提高效率）
- 异步处理（不阻塞主循环）
- 增量检查（避免重复处理）

---

## 十二、注意事项

### 12.1 安全

- 私钥和 Funder 地址应通过环境变量设置，不要提交到代码仓库
- 确保配置文件权限设置正确

### 12.2 风险

- 做市策略存在市场风险，请根据资金情况合理设置参数
- 建议先在测试环境或小额资金下测试
- 定期查看日志，及时发现和解决问题

### 12.3 网络稳定性

- 确保网络连接稳定，避免订单操作失败
- 如果网络不稳定，建议增加重试次数和延迟

### 12.4 监控

- 定期查看日志文件
- 监控订单状态和持仓情况
- 关注敞口和风险指标

---

## 十三、技术支持

如有问题，请查看：

- `README.md`: 详细的使用说明
- `订单检查和对冲止损逻辑总结.md`: 订单检查和对冲逻辑的详细说明
- 日志文件：查看详细的运行日志

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03

